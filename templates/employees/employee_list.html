{% extends 'base.html' %}
{% load django_bootstrap5 %}

{% block title %}Employees - HR Management System{% endblock %}

{% block extra_css %}
<style>
    .employee-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
    }
    .filter-card {
        margin-bottom: 1.5rem;
    }
    .table-responsive {
        overflow-x: auto;
    }
    .action-buttons .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
    }
    .search-box {
        max-width: 300px;
    }
    .status-active {
        background-color: #d1e7dd;
        color: #0f5132;
    }
    .status-probation {
        background-color: #fff3cd;
        color: #664d03;
    }
    .status-terminated {
        background-color: #f8d7da;
        color: #842029;
    }
    .status-notice_period {
        background-color: #cff4fc;
        color: #055160;
    }
    .status-badge {
        font-size: 0.8rem;
        padding: 0.25em 0.6em;
        border-radius: 0.25rem;
    }
    .bulk-actions {
        display: none;
    }
</style>
{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'core:dashboard' %}">Dashboard</a></li>
        <li class="breadcrumb-item active" aria-current="page">Employees</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0 text-gray-800">
        <i class="fas fa-users me-2"></i>Employees
    </h1>
    <div>
        {% if user.is_staff %}
        <a href="{% url 'employees:create' %}" class="btn btn-primary">
            <i class="fas fa-user-plus me-1"></i>Add Employee
        </a>
        <div class="dropdown d-inline-block ms-2">
            <button class="btn btn-secondary dropdown-toggle" type="button" id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-download me-1"></i>Export
            </button>
            <ul class="dropdown-menu" aria-labelledby="exportDropdown">
                <li><a class="dropdown-item" href="{% url 'employees:export' %}?format=csv"><i class="fas fa-file-csv me-1"></i>CSV</a></li>
                <li><a class="dropdown-item" href="{% url 'employees:export' %}?format=excel"><i class="fas fa-file-excel me-1"></i>Excel</a></li>
                <li><a class="dropdown-item" href="{% url 'employees:export' %}?format=pdf"><i class="fas fa-file-pdf me-1"></i>PDF</a></li>
            </ul>
        </div>
        {% endif %}
    </div>
</div>

<!-- Filters and Search -->
<div class="card shadow mb-4 filter-card">
    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
        <h6 class="m-0 font-weight-bold text-primary">
            <i class="fas fa-filter me-1"></i>Filters
        </h6>
        <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse" aria-expanded="false" aria-controls="filterCollapse">
            <i class="fas fa-chevron-down"></i>
        </button>
    </div>
    <div class="collapse show" id="filterCollapse">
        <div class="card-body">
            <form method="get" action="{% url 'employees:list' %}" class="row g-3">
                <div class="col-md-3">
                    <label for="department" class="form-label">Department</label>
                    <select name="department" id="department" class="form-select">
                        <option value="">All Departments</option>
                        {% for department in departments %}
                            <option value="{{ department.id }}" {% if selected_filters.department == department.id|stringformat:"i" %}selected{% endif %}>
                                {{ department.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="store" class="form-label">Store</label>
                    <select name="store" id="store" class="form-select">
                        <option value="">All Stores</option>
                        {% for store in stores %}
                            <option value="{{ store.id }}" {% if selected_filters.store == store.id|stringformat:"i" %}selected{% endif %}>
                                {{ store.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="status" class="form-label">Status</label>
                    <select name="status" id="status" class="form-select">
                        <option value="">All Statuses</option>
                        {% for status_value, status_label in status_choices %}
                            <option value="{{ status_value }}" {% if selected_filters.status == status_value %}selected{% endif %}>
                                {{ status_label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="employment_type" class="form-label">Employment Type</label>
                    <select name="employment_type" id="employment_type" class="form-select">
                        <option value="">All Types</option>
                        {% for type_value, type_label in employment_type_choices %}
                            <option value="{{ type_value }}" {% if selected_filters.employment_type == type_value %}selected{% endif %}>
                                {{ type_label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="search" class="form-label">Search</label>
                    <div class="input-group search-box">
                        <input type="text" class="form-control" id="search" name="q" placeholder="Search by name, ID, email..." value="{{ request.GET.q|default:'' }}">
                        <button class="btn btn-primary" type="submit">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">Apply Filters</button>
                    <a href="{% url 'employees:list' %}" class="btn btn-outline-secondary">Clear Filters</a>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bulk Actions -->
<div class="bulk-actions card shadow mb-4">
    <div class="card-body">
        <form method="post" action="{% url 'employees:bulk_action' %}">
            {% csrf_token %}
            <div class="d-flex align-items-center">
                <span class="me-3"><span id="selected-count">0</span> employees selected</span>
                <select name="bulk_action" class="form-select me-3" style="width: auto;">
                    <option value="">Select Action</option>
                    <option value="delete">Delete Selected</option>
                    <option value="change_status">Change Status</option>
                    <option value="change_department">Change Department</option>
                </select>
                
                <div class="status-options d-none me-3">
                    <select name="new_status" class="form-select">
                        <option value="">Select Status</option>
                        {% for status_value, status_label in status_choices %}
                            <option value="{{ status_value }}">{{ status_label }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="department-options d-none me-3">
                    <select name="new_department" class="form-select">
                        <option value="">Select Department</option>
                        {% for department in departments %}
                            <option value="{{ department.id }}">{{ department.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <button type="submit" class="btn btn-primary" id="apply-bulk-action">
                    Apply
                </button>
                <button type="button" class="btn btn-outline-secondary ms-2" id="cancel-bulk-selection">
                    Cancel
                </button>
            </div>
            <div id="selected-employees-container"></div>
        </form>
    </div>
</div>

<!-- Employee List -->
<div class="card shadow mb-4">
    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
        <h6 class="m-0 font-weight-bold text-primary">
            <i class="fas fa-list me-1"></i>Employee List
        </h6>
        <span class="text-muted">{{ page_obj.paginator.count }} employees found</span>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover table-striped">
                <thead>
                    <tr>
                        {% if user.is_staff %}
                        <th>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="select-all">
                            </div>
                        </th>
                        {% endif %}
                        <th>Employee ID</th>
                        <th>Name</th>
                        <th>Department</th>
                        <th>Role</th>
                        <th>Joined Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for employee in page_obj %}
                    <tr>
                        {% if user.is_staff %}
                        <td>
                            <div class="form-check">
                                <input class="form-check-input employee-select" type="checkbox" name="selected_employees" value="{{ employee.id }}">
                            </div>
                        </td>
                        {% endif %}
                        <td>{{ employee.employee_id }}</td>
                        <td>
                            <div class="d-flex align-items-center">
                                {% if employee.profile_picture %}
                                    <img src="{{ employee.profile_picture.url }}" alt="{{ employee.full_name }}" class="employee-avatar me-2">
                                {% else %}
                                    <div class="bg-primary text-white rounded-circle employee-avatar me-2 d-flex align-items-center justify-content-center">
                                        {{ employee.first_name|first }}{{ employee.last_name|first }}
                                    </div>
                                {% endif %}
                                <div>
                                    <a href="{% url 'employees:detail' employee_id=employee.id %}">
                                        {{ employee.full_name }}
                                    </a>
                                    <div class="small text-muted">{{ employee.official_email }}</div>
                                </div>
                            </div>
                        </td>
                        <td>{{ employee.department.name|default:"--" }}</td>
                        <td>{{ employee.role.name|default:"--" }}</td>
                        <td>{{ employee.date_joined|date:"M d, Y" }}</td>
                        <td>
                            <span class="status-badge status-{{ employee.status }}">
                                {{ employee.get_status_display }}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <a href="{% url 'employees:detail' employee_id=employee.id %}" class="btn btn-sm btn-info" title="View">
                                    <i class="fas fa-eye"></i>
                                </a>
                                {% if user.is_staff %}
                                <a href="{% url 'employees:update' employee_id=employee.id %}" class="btn btn-sm btn-primary" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <div class="dropdown d-inline-block">
                                    <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton{{ employee.id }}" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton{{ employee.id }}">
                                        <li><a class="dropdown-item" href="{% url 'employees:documents' employee_id=employee.id %}">
                                            <i class="fas fa-file me-1"></i>Documents
                                        </a></li>
                                        <li><a class="dropdown-item" href="{% url 'employees:contacts' employee_id=employee.id %}">
                                            <i class="fas fa-address-book me-1"></i>Emergency Contacts
                                        </a></li>
                                        <li><a class="dropdown-item" href="{% url 'employees:education' employee_id=employee.id %}">
                                            <i class="fas fa-graduation-cap me-1"></i>Education
                                        </a></li>
                                        <li><a class="dropdown-item" href="{% url 'employees:experience' employee_id=employee.id %}">
                                            <i class="fas fa-briefcase me-1"></i>Work Experience
                                        </a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger" href="{% url 'employees:delete' employee_id=employee.id %}">
                                            <i class="fas fa-trash me-1"></i>Delete
                                        </a></li>
                                    </ul>
                                </div>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="{% if user.is_staff %}8{% else %}7{% endif %}" class="text-center py-4">
                            <div class="text-muted">
                                <i class="fas fa-search fa-2x mb-3"></i>
                                <p>No employees found matching your criteria.</p>
                                {% if request.GET %}
                                    <a href="{% url 'employees:list' %}" class="btn btn-outline-primary">Clear Filters</a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if page_obj.paginator.num_pages > 1 %}
        <div class="d-flex justify-content-center mt-4">
            {% bootstrap_pagination page_obj %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle bulk action selection
        const bulkActionSelect = document.querySelector('select[name="bulk_action"]');
        const statusOptions = document.querySelector('.status-options');
        const departmentOptions = document.querySelector('.department-options');
        
        bulkActionSelect.addEventListener('change', function() {
            statusOptions.classList.add('d-none');
            departmentOptions.classList.add('d-none');
            
            if (this.value === 'change_status') {
                statusOptions.classList.remove('d-none');
            } else if (this.value === 'change_department') {
                departmentOptions.classList.remove('d-none');
            }
        });
        
        // Handle select all checkbox
        const selectAllCheckbox = document.getElementById('select-all');
        const employeeCheckboxes = document.querySelectorAll('.employee-select');
        const bulkActions = document.querySelector('.bulk-actions');
        const selectedCount = document.getElementById('selected-count');
        const selectedContainer = document.getElementById('selected-employees-container');
        
        selectAllCheckbox?.addEventListener('change', function() {
            employeeCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateBulkActions();
        });
        
        employeeCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateBulkActions);
        });
        
        document.getElementById('cancel-bulk-selection')?.addEventListener('click', function() {
            selectAllCheckbox.checked = false;
            employeeCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            updateBulkActions();
        });
        
        function updateBulkActions() {
            const checkedBoxes = document.querySelectorAll('.employee-select:checked');
            selectedCount.textContent = checkedBoxes.length;
            
            if (checkedBoxes.length > 0) {
                bulkActions.style.display = 'block';
                
                // Clear previous hidden inputs
                selectedContainer.innerHTML = '';
                
                // Add hidden inputs for selected employees
                checkedBoxes.forEach(checkbox => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'selected_employees';
                    input.value = checkbox.value;
                    selectedContainer.appendChild(input);
                });
            } else {
                bulkActions.style.display = 'none';
            }
        }
        
        // Initialize bulk actions visibility
        updateBulkActions();
    });
</script>
{% endblock %}
